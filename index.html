<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pension Calculation App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- NEW: Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.25rem;
            color: #4A5568;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #CBD5E0;
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4299E1;
            box-shadow: 0 0 0 1px #4299E1;
        }
        .input-group input[readonly] {
            background-color: #F7FAFC;
            cursor: not-allowed;
            font-weight: 600;
        }
        /* Style for disabled inputs */
        .input-group input:disabled, 
        .input-group select:disabled,
        .pension-stepper button:disabled {
            background-color: #F7FAFC;
            color: #A0AEC0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* NEW: Styles for the pension input with stepper buttons */
        .pension-input-wrapper {
            display: flex;
            align-items: center;
        }
        .pension-input-wrapper input {
            flex-grow: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            /* Ensure it doesn't get too small */
            min-width: 50px; 
        }
        .pension-stepper {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .pension-stepper button {
            width: 2.5rem; /* 40px */
            height: 1.25rem; /* 20px */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #F1F5F9; /* slate-100 */
            border: 1px solid #CBD5E0; /* cool-gray-300 */
            color: #4A5568; /* cool-gray-600 */
            font-weight: 600;
            line-height: 1;
            transition: background-color 0.15s ease-in-out;
            /* Prevent text selection on rapid clicks */
            user-select: none;
        }
        .pension-stepper button:hover:not(:disabled) {
            background-color: #E2E8F0; /* slate-200 */
        }
        .pension-stepper button:first-child {
            border-top-right-radius: 0.375rem;
            border-bottom-width: 0.5px;
            border-left-width: 0;
        }
        .pension-stepper button:last-child {
            border-bottom-right-radius: 0.375rem;
            border-top-width: 0.5px;
            border-left-width: 0;
        }
        /* End new styles */

        .output-group {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #E2E8F0;
        }
        .output-group:last-child {
            border-bottom: none;
        }
        .output-group .label {
            font-weight: 500;
            color: #2D3748;
        }
        .output-group .value {
            font-weight: 600;
            /* Overridden by specific classes for restoration date */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
        }
        /* Flashing effect for past/current date */
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .flashing {
            animation: flash 1.5s infinite;
        }
        /* Custom styles for the increase table */
        .increase-table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        .increase-table {
            width: 100%;
            min-width: 1000px; /* Reduced from 1200px to shrink width */
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .increase-table th, .increase-table td {
            padding: 8px 4px; /* Reduced horizontal padding */
            border: 1px solid #000;
            text-align: center;
            vertical-align: middle;
        }
        .increase-table th {
            background-color: #F7FAFC;
            font-weight: 600;
            color: #2D3748;
            text-transform: uppercase;
        }
        .increase-table .header-group th {
            padding: 12px 4px;
        }
        .increase-table .sub-header th {
            font-weight: 500;
        }
        
        /* New class to hide columns */
        .hidden-column {
            display: none;
        }

        /* --- NEW: Password Modal Styles --- */
        .modal-overlay {
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            /* Hidden by default */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content .input-group {
            margin-bottom: 1rem;
        }
        .modal-content .input-group label {
            font-weight: 600;
            color: #2D3748;
        }
        .modal-content .input-group input {
            border-color: #A0AEC0;
        }
        .modal-content .input-group input:focus {
            border-color: #3182CE;
            box-shadow: 0 0 0 1px #3182CE;
        }
        /* --- End Modal Styles --- */


        /* --- Mobile Responsive Styles --- */
        @media (max-width: 768px) {
            .logo-left {
                display: none; /* Hide logo on mobile */
            }
            .container {
                padding: 1rem; /* Reduce padding on mobile */
            }
            .card {
                padding: 1rem; /* Reduce card padding */
            }
            header h1 {
                font-size: 1.875rem; /* 30px */
            }
            header p {
                font-size: 0.875rem; /* 14px */
            }
            .increase-table-container {
                /* Allow table to be scrollable on mobile */
                overflow-x: auto;
            }
            .increase-table {
                min-width: 800px; /* Further reduce min-width for mobile */
            }
            /* Make final entitlement table stack */
            .output-group {
                flex-direction: column;
                align-items: flex-start;
                padding: 0.5rem 0;
            }
            .output-group .label {
                margin-bottom: 0.25rem;
                font-size: 0.875rem; /* 14px */
            }
            .output-group .value {
                font-size: 1rem; /* 16px */
                padding-left: 0.5rem; /* Indent value slightly */
            }
             /* Special handling for the header row in the final table */
            .output-group.font-bold {
                flex-direction: row; /* Keep header as row */
                justify-content: space-between;
            }
            .output-group.font-bold .label {
                 margin-bottom: 0;
                 font-size: 1rem; /* 16px */
                 width: auto !important; /* Override width */
            }
             /* Special handling for the 3-column rows in final table */
             .output-group .w-1\/3 {
                width: 100% !important; /* Make columns full width */
                text-align: left !important; /* Align text left */
                padding-left: 0.5rem; /* Indent */
            }
            .output-group .w-1\/3.label {
                padding-left: 0; /* No indent for label */
                font-size: 0.875rem; /* 14px */
                margin-bottom: 0.25rem;
            }
            /* Hide the empty span in the header on mobile */
            .output-group.font-bold .label.w-1\/3:first-child {
                display: none;
            }
        }
        /* --- End Mobile Styles --- */
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- App Warning Bar -->
    <div id="app-warning" class="p-4 text-center text-yellow-800 bg-yellow-100 rounded-lg m-4" style="display: none;"></div>

    <div class="container mx-auto p-4 md:p-8 relative"> 
        <!-- Logo Container -->
        <div class="logo-container flex flex-col md:flex-row justify-between items-center">
            <img src="logo.gif" alt="Logo" class="logo-left md:absolute md:top-4 md:left-4 w-32 h-32 object-contain" onerror="this.src='https://placehold.co/128x128/eeeeee/aaaaaa?text=Logo'; this.onerror=null;">
        </div>
        
        <header class="text-center mb-8 mt-4 md:mt-0">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Pension Calculator</h1>
            <p class="text-red-600 mt-1">(For Retirement date 01 July, 1986 to till now)</p>
            <p class="text-blue-600 mt-1 font-medium">Designed by Chf Wrt Off Irfan Mahmud Sect Asstt</p>
        </header>

        <!-- Wrapper for print grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="card">
                <h2 class="card-title text-center font-bold text-xl">Input Details</h2>
                <form id="pension-form">
                    <!-- Service Details -->
                    <h3 class="font-semibold text-lg mt-6 mb-2 text-gray-600 border-b pb-2">Service & Personal</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        
                        <div class="input-group">
                            <label for="dob">Date of Birth (DOB)</label>
                            <input type="date" id="dob" class="calc-input">
                            <div id="dob-display" class="text-xs text-gray-500 mt-1"></div>
                        </div>
                        <div class="input-group">
                            <label for="doe">Date of Enrollment (DOE)</label>
                            <input type="date" id="doe" class="calc-input" disabled>
                            <div id="doe-display" class="text-xs text-gray-500 mt-1"></div>
                        </div>
                        <div class="input-group">
                            <label for="sos">Date of Retirment (SOS)</label>
                            <input type="date" id="sos" class="calc-input" disabled>
                            <div id="sos-display" class="text-xs text-gray-500 mt-1"></div>
                        </div>
                        <div class="input-group">
                            <label for="gross-pension-ppo">Gross Pension as per PPO</label>
                            <div class="pension-input-wrapper">
                                <input type="text" id="gross-pension-ppo" class="calc-input" disabled>
                                <div class="pension-stepper">
                                    <button type="button" id="increase-pension" aria-label="Increase pension" disabled>+</button>
                                    <button type="button" id="decrease-pension" aria-label="Decrease pension" disabled>-</button>
                                </div>
                            </div>
                        </div>
                         <div class="input-group">
                            <label for="tk-award">TK Award</label>
                            <select id="tk-award" class="calc-input" disabled>
                                <option value="No" selected>No</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                        <div class="input-group">
                           <label for="family-pension">Family Pension</label>
                            <select id="family-pension" class="calc-input" disabled>
                                <option value="No" selected>No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Output Section -->
            <div class="card">
                <h2 class="card-title text-center font-bold text-xl py-4">Calculated Results</h2>
                
                <h3 class="font-semibold text-lg mt-6 mb-2 text-gray-600 border-b pb-2">Service Summary</h3>
                <div class="mt-4 space-y-2">
                    <div class="output-group">
                        <span class="label">Qualifying Service (QS)</span>
                        <span class="value text-gray-800" id="qs-output">0 Years</span>
                    </div>
                    <div class="output-group">
                        <span class="label">Age on next Birthday after SOS</span>
                        <span class="value text-gray-800" id="age-at-sos-output">0 Years</span>
                    </div>
                     <div class="output-group">
                        <span class="label">Commutation Purchase Value</span>
                        <span class="value text-gray-800" id="commutation-factor-output">0</span>
                    </div>
                </div>
                
                <h3 class="font-semibold text-lg mt-6 mb-2 text-gray-600 border-b pb-2">Pension Details</h3>
                 <div class="mt-4 space-y-2">
                    <div class="output-group">
                        <span class="label">Gross Pension</span>
                        <span class="value text-gray-800" id="gross-pension-output">0</span>
                    </div>
                    <div class="output-group">
                        <span class="label">Net Pension (Before Increases)</span>
                        <span class="value text-gray-800" id="net-pension-pre-increase-output">0</span>
                    </div>
                    <div class="output-group">
                        <span class="label">Commuted Pension</span>
                        <span class="value text-gray-800" id="commuted-pension-output">0</span>
                    </div>
                     <div class="output-group">
                        <span class="label">Commutation Amount</span>
                        <span class="value text-gray-800" id="commutation-amount-output">0</span>
                    </div>
                 </div>

                <!-- This section remains visible on screen -->
                <div>
                    <h3 class="font-semibold text-lg mt-6 mb-2 text-gray-600 border-b pb-2">Final Pension After Increases</h3>
                     <div class="mt-4 space-y-2"> 
                        <div class="output-group">
                            <span class="label w-1/3 whitespace-nowrap">Pension (Current)</span>
                            <span class="value w-1/3 text-right text-gray-800" id="pension-pm-current-output">0</span>
                        </div>
                        <div class="output-group">
                            <span class="label w-1/3 whitespace-nowrap">Pension (After Restoration)</span>
                            <span class="value w-1/3 text-right text-gray-800" id="pension-pm-restored-output">0</span>
                        </div>
                        <div class="output-group">
                            <span class="label w-1/3 whitespace-nowrap">TK Allowance</span>
                            <span class="value w-1/3 text-right text-gray-800" id="tk-allowance-current-output">0</span>
                        </div>

                        <!-- UPDATED: Total Payable (Current) - Matching other rows structure -->
                        <div class="output-group">
                            <span class="label w-1/3 whitespace-nowrap">Total Payable (Current)</span>
                            <span class="value w-1/3 text-right text-blue-600 font-bold" id="total-payable-current-output">0</span>
                        </div>

                        <!-- UPDATED: Total Payable (Restored) - Matching other rows structure -->
                        <div class="output-group">
                            <span class="label w-1/3 whitespace-nowrap">Total Payable (Restored)</span>
                            <span class="value w-1/3 text-right text-green-600 font-bold" id="total-payable-restored-output">0</span>
                        </div>

                         <div class="output-group pt-4"> 
                            <span class="label w-1/3 whitespace-nowrap">Pension Restoration Date</span>
                            <span class="value text-right" id="restoration-date-output"></span>
                        </div>
                        <div class="output-group">
                            <span class="label w-1/3 whitespace-nowrap">Age on Pension Restoration</span>
                            <span class="value text-gray-800 text-right" id="age-at-restoration-output">0 Years</span>
                        </div>
                     </div>
                </div>
            </div>
        </div>

        <!-- Pension Increase Calculations Table -->
        <div class="card mt-8">
            <h2 class="card-title text-center font-bold text-xl mb-4">Pension Increase Calculations</h2>
            <div class="increase-table-container">
                <table class="increase-table">
                    <thead>
                        <tr class="header-group">
                            <th rowspan="2" class="bg-blue-100 text-blue-600">Increase Year</th>
                            <th rowspan="2" class="bg-blue-100 text-blue-600">%age</th>
                            <th colspan="3" class="bg-blue-200 text-blue-700">Current</th>
                            <th colspan="3" class="bg-green-200 text-green-700">After Restoration</th>
                            <!-- Hidden columns -->
                            <th rowspan="2" class="bg-blue-100 text-blue-600 hidden-column">Entitled</th>
                            <th rowspan="2" class="bg-blue-100 text-blue-600 hidden-column">From</th>
                            <th rowspan="2" class="bg-blue-100 text-blue-600 hidden-column">To</th>
                            <th colspan="2" class="bg-cyan-200 text-cyan-700 hidden-column">Minimum Pension</th>
                        </tr>
                        <tr classs="sub-header">
                            <th>Base Line</th>
                            <th>Increase</th>
                            <th>Net</th>
                            <th>Base Line</th>
                            <th>Increase</th>
                            <th>Net</th>
                            <!-- Hidden sub-headers -->
                            <th class="hidden-column">Self</th>
                            <th class="hidden-column">Family</th>
                        </tr>
                    </thead>
                    <tbody id="increase-table-body">
                        <!-- Rows populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Total Visits Display -->
        <div class="flex justify-end mt-4" id="visit-counter-wrapper">
             <p id="visit-counter" class="text-right text-sm font-medium text-gray-600">Total Visits: <span id="visit-count" class="font-bold text-gray-800">0</span></p>
        </div>

        <!-- Calculation Log -->
        <div class="card mt-2" id="log-wrapper">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title font-bold text-xl">Calculation Log</h2>
                <button id="clear-log-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-1 px-3 rounded-lg transition-colors">
                    Clear Log
                </button>
            </div>
            <div id="log-container" class="h-48 overflow-y-auto bg-gray-50 border border-gray-200 rounded-lg p-3 text-xs font-mono">
                <span class="text-gray-400">Loading log...</span>
            </div>
        </div>

    </div>

    <!-- Password Modal HTML -->
    <div id="password-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Enter Password</h3>
            <div class="input-group">
                <label for="password-input">Password</label>
                <input type="password" id="password-input" class="w-full" placeholder="Enter password to clear log">
            </div>
            <p id="password-error" class="text-red-500 text-sm mb-4" style="display: none;">Incorrect password. Please try again.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-clear-btn" type="button" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="confirm-clear-btn" type="button" class="text-sm bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    <!-- End Modal -->


    <!-- ====================================================================== -->
    <!-- SUPABASE SCRIPT -->
    <!-- ====================================================================== -->
    <script type="module">
        // NEW: Import Supabase createClient
        const { createClient } = supabase;

        // --- NEW: YOUR SUPABASE URL AND ANON KEY ---
        const SUPABASE_URL = "https://xyfibnqodbisyykjrrbs.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5ZmlibnFvZGJpc3l5a2pycmJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTc1NjMsImV4cCI6MjA3ODYzMzU2M30.GodY0oqueaXq15tRYM1Lyaw5regYnPOg6v4aAaBPqgM";
        // --------------------------------------------------

        // --- App State Variables ---
        let supabaseClient;
        let isSupabaseEnabled = false;

        // Debounce timer for logging
        let logDebounceTimer = null;
        const LOG_DEBOUNCE_DELAY = 10000; // 10 seconds

        // NEW: Store calculated values for logging
        let currentCalculatedValues = { 
            pensionCurrent: 0, 
            pensionRestored: 0, 
            restorationDate: 'N/A',
            tkAllowance: 0 // <-- ADDED
        };

        // --- 1. HELPER FUNCTIONS (Remain unchanged) ---

        const getTodayDateString = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const todayDateString = getTodayDateString(); 

        const roundToTwoDecimals = (num) => {
            if (typeof num !== 'number' || isNaN(num)) return 0;
            const epsilon = 0.0000001; 
            return Math.round((num + epsilon) * 100) / 100;
        }
        
        const roundToNearestWhole = (num) => {
            if (typeof num !== 'number' || isNaN(num)) return 0;
            const rounded = Math.round(num);
            return rounded;
        }

        const formatCurrency = (value, roundToWhole = false, forTable = false) => {
            const numericValue = parseFloat(value);
            if (isNaN(numericValue) || numericValue === 0) return '-';
            
            let roundedValue;
            let minimumFractionDigits;
            let maximumFractionDigits;

            if (roundToWhole) {
                roundedValue = roundToNearestWhole(numericValue);
                minimumFractionDigits = 0;
                maximumFractionDigits = 0;
            } else {
                roundedValue = roundToTwoDecimals(numericValue);
                minimumFractionDigits = 2;
                maximumFractionDigits = 2;
            }
            
            const prefix = forTable ? '' : 'Rs. ';
            return prefix + roundedValue.toLocaleString('en-IN', { minimumFractionDigits, maximumFractionDigits });
        };
        
        const parseDate = (dateString) => {
            if (!dateString) return null;
            const date = new Date(dateString + 'T00:00:00Z');
            return isNaN(date.getTime()) ? null : date;
        };

        const formatDateDisplay = (date) => {
            if (!date) return 'N/A';
            const options = { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' };
            return date.toLocaleString('en-GB', options).replace(/ /g, '-').toUpperCase();
        };
        
        const formatDateTable = (dateString) => {
            const parts = dateString.split('-');
            if (parts.length === 3 && parts[0].length === 4) {
                const year = parts[0];
                const month = parseInt(parts[1]) - 1;
                const day = parts[2];
                const dateForDisplay = new Date(Date.UTC(year, month, day));
                return dateForDisplay.toLocaleString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' }).replace(/ /g, '-').toUpperCase();
            }
            return dateString;
        };
        
        const formatDateForLog = (dateString) => {
            if (!dateString) return 'N/A';
            const parts = dateString.split('-');
            if (parts.length === 3 && parts[0].length === 4) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateString;
        };
        
        // NEW: Format visit count to K/M
        const formatVisitCount = (num) => {
            if (!num || num < 1000) {
                return num || 0;
            } else if (num < 1000000) {
                return (num / 1000).toFixed(num % 1000 === 0 ? 0 : 1) + 'K';
            } else {
                return (num / 1000000).toFixed(num % 1000000 === 0 ? 0 : 1) + 'M';
            }
        };


        // --- 2. DATA CONSTANTS (Remain unchanged) ---

        const pensionData = [
            { age: 20, val_2001: 40.5043, val_1986: 50.6304, val_1966: 24.265 }, { age: 21, val_2001: 39.7341, val_1986: 49.6676, val_1966: 24.061 }, { age: 22, val_2001: 38.9653, val_1986: 48.7066, val_1966: 23.853 }, { age: 23, val_2001: 38.1974, val_1986: 47.7467, val_1966: 23.64 }, { age: 24, val_2001: 37.4307, val_1986: 46.7884, val_1966: 23.424 }, { age: 25, val_2001: 36.6651, val_1986: 45.8314, val_1966: 23.203 }, { age: 26, val_2001: 35.9006, val_1986: 44.8758, val_1966: 22.978 }, { age: 27, val_2001: 35.1372, val_1986: 43.9215, val_1966: 22.747 }, { age: 28, val_2001: 34.375, val_1986: 42.9688, val_1966: 22.513 }, { age: 29, val_2001: 33.6143, val_1986: 42.0179, val_1966: 22.273 }, { age: 30, val_2001: 32.8071, val_1986: 41.0089, val_1966: 22.028 }, { age: 31, val_2001: 32.0974, val_1986: 40.1218, val_1966: 21.077 }, { age: 32, val_2001: 31.3412, val_1986: 39.1767, val_1966: 21.522 }, { age: 33, val_2001: 30.5869, val_1986: 38.2336, val_1966: 21.26 }, { age: 34, val_2001: 29.8343, val_1986: 37.2929, val_1966: 20.993 }, { age: 35, val_2001: 29.0841, val_1986: 36.3551, val_1966: 20.72 }, { age: 36, val_2001: 28.3362, val_1986: 35.4203, val_1966: 20.442 }, { age: 37, val_2001: 27.5908, val_1986: 34.4885, val_1966: 20.157 }, { age: 38, val_2001: 26.8482, val_1986: 33.5603, val_1966: 19.867 }, { age: 39, val_2001: 26.1009, val_1986: 32.6361, val_1966: 19.57 }, { age: 40, val_2001: 25.3728, val_1986: 31.716, val_1966: 19.267 }, { age: 41, val_2001: 24.6406, val_1986: 30.8007, val_1966: 18.956 }, { age: 42, val_2001: 23.9126, val_1986: 29.8907, val_1966: 18.641 }, { age: 43, val_2001: 23.184, val_1986: 28.98, val_1966: 18.318 }, { age: 44, val_2001: 22.4713, val_1986: 28.0891, val_1966: 17.988 }, { age: 45, val_2001: 21.7592, val_1986: 27.199, val_1966: 17.65 }, { age: 46, val_2001: 21.0538, val_1986: 26.3172, val_1966: 17.307 }, { age: 47, val_2001: 20.3555, val_1986: 25.4444, val_1966: 16.956 }, { age: 48, val_2001: 19.6653, val_1986: 24.5816, val_1966: 16.596 }, { age: 49, val_2001: 18.9841, val_1986: 23.7301, val_1966: 16.231 }, { age: 50, val_2001: 18.3129, val_1986: 22.8911, val_1966: 15.859 }, { age: 51, val_2001: 17.6526, val_1986: 22.0658, val_1966: 15.481 }, { age: 52, val_2001: 17.005, val_1986: 21.2563, val_1966: 15.096 }, { age: 53, val_2001: 16.371, val_1986: 20.638, val_1966: 14.707 }, { age: 54, val_2001: 15.7517, val_1986: 19.6896, val_1966: 14.313 }, { age: 55, val_2001: 15.1478, val_1986: 18.9348, val_1966: 13.915 }, { age: 56, val_2001: 14.5602, val_1986: 18.2002, val_1966: 13.513 }, { age: 57, val_2001: 13.9888, val_1986: 17.486, val_1966: 13.109 }, { age: 58, val_2001: 13.434, val_1986: 16.7925, val_1966: 12.702 }, { age: 59, val_2001: 12.8953, val_1986: 16.1191, val_1966: 12.294 }, { age: 60, val_2001: 12.3719, val_1986: 15.4649, val_1966: 11.886 }, { age: 61, val_2001: 11.8632, val_1986: 14.829, val_1966: 11.497 }, { age: 62, val_2001: 11.3684, val_1986: 14.2105, val_1966: 11.104 }, { age: 63, val_2001: 10.8872, val_1986: 13.609, val_1966: 10.713 }, { age: 64, val_2001: 10.4191, val_1986: 13.0239, val_1966: 10.327 }, { age: 65, val_2001: 9.9636, val_1986: 12.4549, val_1966: 9.946 }, { age: 66, val_2001: 9.5214, val_1986: 11.9017, val_1966: 9.57 }, { age: 67, val_2001: 9.0914, val_1986: 11.3643, val_1966: 9.2 }, { age: 68, val_2001: 8.6742, val_1986: 10.5428, val_1966: 8.836 }, { age: 69, val_2001: 8.2697, val_1986: 10.3371, val_1966: 8.478 }, { age: 70, val_2001: 7.8778, val_1986: 9.8472, val_1966: 8.127 }, { age: 71, val_2001: 7.4983, val_1986: 9.3729, val_1966: 7.783 }, { age: 72, val_2001: 7.1314, val_1986: 8.9142, val_1966: 7.448 }, { age: 73, val_2001: 6.7766, val_1986: 8.4708, val_1966: 7.121 }, { age: 74, val_2001: 6.4342, val_1986: 8.0427, val_1966: 6.802 }, { age: 75, val_2001: 6.1039, val_1986: 7.6299, val_1966: 6.494 }, { age: 76, val_2001: 5.7858, val_1986: 7.2322, val_1966: 6.194 }, { age: 77, val_2001: 5.4797, val_1986: 6.8496, val_1966: 5.906 }, { age: 78, val_2001: 5.1854, val_1986: 6.4818, val_1966: 5.627 }, { age: 79, val_2001: 4.903, val_1986: 6.1284, val_1966: 5.364 }, { age: 80, val_2001: 4.6321, val_1986: 5.7901, val_1966: 5.104 }
        ];
        
        const factors_2001_12_01 = {};
        const factors_1986_07_01 = {};
        const factors_1966_07_01 = {};
        pensionData.forEach(item => {
            factors_2001_12_01[item.age] = item.val_2001;
            factors_1986_07_01[item.age] = item.val_1986;
            factors_1966_07_01[item.age] = item.val_1966;
        });
        
        const minPensionData = {
            1988: { self: 300.00, family: 150.00 }, 1995: { self: 300.00, family: 150.00 }, 1997: { self: 300.00, family: 150.00 }, 1999: { self: 300.00, family: 150.00 }, 2008: { self: 2000.00, family: 1000.00 }, 2010: { self: 3000.00, family: 2250.00 }, 2013: { self: 5000.00, family: 3750.00 }, 2014: { self: 6000.00, family: 4500.00 }, 2018: { self: 10000.00, family: 7500.00 }, 2023: { self: 12000.00, family: 9000.00 }
        };

        const pensionIncreases = [
            { year: 1987, percentage: '4%', from: '1987-06-30', to: '1987-06-30' }, { year: 1988, percentage: '7%', from: '1988-06-30', to: '1988-06-30' }, { year: 1990, percentage: '10%', from: '1990-06-30', to: '1990-06-30' }, { year: 1991, percentage: 'CONDITIONAL', from: '1991-06-30', to: '1991-06-30' }, { year: 1995, percentage: 'CONDITIONAL', from: '1995-07-01', to: '1995-07-01' }, { year: 1997, percentage: '10%', from: '1997-02-28', to: '1997-02-28' }, { year: 1999, percentage: '25%', from: '1999-07-01', to: '2001-11-30' }, { year: 2001, percentage: 'CONDITIONAL', from: '2001-11-30', to: '2001-11-30' }, { year: 2003, percentage: '15%', from: '2003-07-01', to: '2005-06-30' }, { year: 2004, percentage: 'CONDITIONAL', from: '2004-07-01', to: '2005-06-30' }, { year: 2005, percentage: '10%', from: '2005-07-01', to: '2011-06-30' }, { year: 2006, percentage: 'CONDITIONAL', from: '2006-07-01', to: '2011-06-30' }, { year: 2007, percentage: 'CONDITIONAL', from: '2007-07-01', to: '2007-07-01' }, { year: 2008, percentage: '20%', from: '2008-07-01', to: '2008-07-01' }, { year: 2009, percentage: 'CONDITIONAL', from: '2009-07-01', to: '2011-06-30' }, { year: 2010, percentage: 'CONDITIONAL', from: '2010-07-01', to: '2017-06-30' }, { year: 2011, percentage: 'CONDITIONAL', from: '2011-07-01', to: todayDateString }, { year: 2012, percentage: '20%', from: '2012-07-01', to: '2015-06-30' }, { year: 2013, percentage: '10%', from: '2013-07-01', to: '2016-06-30' }, { year: 2014, percentage: '10%', from: '2014-07-01', to: '2016-06-30' }, { year: 2015, percentage: '7.5%', from: '2012-07-01', to: todayDateString }, { year: 2016, percentage: '10%', from: '2016-07-01', to: '2022-06-30' }, { year: 2017, percentage: '10%', from: '2017-07-01', to: '2022-06-30' }, { year: 2018, percentage: '10%', from: '2018-07-01', to: '2022-06-30' }, { year: 2019, percentage: '10%', from: '2019-07-01', to: '2022-06-30' }, { year: 2021, percentage: '10%', from: '2021-07-01', to: '2022-06-30' }, { year: 2022, percentage: '15%', from: '2022-07-01', to: todayDateString }, { year: 2023, percentage: '17.50%', from: '2023-07-01', to: todayDateString }, { year: 2024, percentage: '15%', from: '2024-07-01', to: todayDateString }, { year: 2025, percentage: '7%', from: '2025-07-01', to: todayDateString } 
        ];

        
        // --- 3. CORE CALCULATION LOGIC (Functions) ---
        
        function renderLog(logArray) {
            const logCountSpan = document.getElementById('log-count');
            if (logCountSpan) {
                logCountSpan.textContent = formatVisitCount(logArray.length);
            }
            
            const logContainer = document.getElementById('log-container');
            if (!logContainer) return;

            if (logArray.length === 0) {
                logContainer.innerHTML = '<span class="text-gray-400">Log starts empty...</span>';
                return;
            }

            let logHTML = '';
            for (const entry of logArray) {
                const log_dob_display = formatDateForLog(entry.dob_raw);
                const log_doe_display = formatDateForLog(entry.doe_raw);
                const log_sos_display = formatDateForLog(entry.sos_raw);
                
                const pensionRaw = entry.pension_raw || '0';
                const parts = pensionRaw.split('.');
                let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                let decimalPart = parts[1] ? (parts[1] + '00').substring(0, 2) : '';
                
                let log_pension_display = integerPart;
                if (decimalPart) log_pension_display += '.' + decimalPart;
                if (parseFloat(pensionRaw) === 0) log_pension_display = '0';
                if (entry.pension_raw === '') log_pension_display = 'N/A';

                // FIX: Read from all-lowercase properties
                logHTML += `<div class="p-2 border-b border-gray-200"><strong>[${entry.displaytimestamp}] ${entry.triggersource}</strong><br>
                    <strong>DOB:</strong> ${log_dob_display}, 
                    <strong>DOE:</strong> ${log_doe_display}, 
                    <strong>SOS:</strong> ${log_sos_display}<br>
                    <strong>Pension:</strong> ${log_pension_display}, 
                    <strong>TK:</strong> ${entry.tk}, 
                    <strong>Family:</strong> ${entry.family}
                    <br>
                    <!-- NEW: Added calculated values in blue -->
                    <strong class="text-blue-600">
                        Current: Rs. ${Math.round(entry.pension_current || 0).toLocaleString('en-IN')}, 
                        Restored: Rs. ${Math.round(entry.pension_restored || 0).toLocaleString('en-IN')}, 
                        TK: Rs. ${(entry.tk_allowance || 0).toLocaleString('en-IN')}, 
                        Date: ${entry.restoration_date || 'N/A'}
                    </strong>
                    <br>
                    <button 
                        class="load-log-btn text-xs bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 rounded-lg transition-colors mt-2"
                        data-dob="${entry.dob_raw || ''}"
                        data-doe="${entry.doe_raw || ''}"
                        data-sos="${entry.sos_raw || ''}"
                        data-pension="${entry.pension_raw || '0'}"
                        data-tk="${entry.tk}"
                        data-family="${entry.family}">
                        Load this Data
                    </button>
                </div>`;
            }
            logContainer.innerHTML = logHTML;
        }

        // --- NEW: Supabase Log Function (with duplicate checking) ---
        async function logCalculation(triggerSource) {
            if (!isSupabaseEnabled) return; 

            const dobInput = document.getElementById('dob');
            const doeInput = document.getElementById('doe');
            const sosInput = document.getElementById('sos');
            const grossPensionInput = document.getElementById('gross-pension-ppo');
            const tkAwardInput = document.getElementById('tk-award');
            const familyPensionInput = document.getElementById('family-pension');


            const log_dob_raw = dobInput.value;
            const log_doe_raw = doeInput.value;
            const log_sos_raw = sosInput.value;
            const log_pension_raw = grossPensionInput.value.replace(/,/g, '') || '0';
            const log_tk = tkAwardInput.value;
            const log_family = familyPensionInput.value;
            
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const time = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            // FIX: Use all-lowercase keys to match the database
            const logEntry = {
                // created_at is added automatically by Supabase
                displaytimestamp: `${day}-${month}-${year} ${time}`,
                triggersource: triggerSource,
                dob_raw: log_dob_raw,
                doe_raw: log_doe_raw,
                sos_raw: log_sos_raw,
                pension_raw: log_pension_raw,
                tk: log_tk,
                family: log_family,
                // NEW: Add calculated values
                pension_current: currentCalculatedValues.pensionCurrent,
                pension_restored: currentCalculatedValues.pensionRestored,
                restoration_date: currentCalculatedValues.restorationDate,
                tk_allowance: currentCalculatedValues.tkAllowance // <-- ADDED
            };

            try {
                // 1. Check for and delete duplicates
                const { error: deleteError } = await supabaseClient
                    .from('logs')
                    .delete()
                    .match({
                        dob_raw: log_dob_raw,
                        doe_raw: log_doe_raw,
                        sos_raw: log_sos_raw,
                        pension_raw: log_pension_raw,
                        tk: log_tk,
                        family: log_family,
                        // NEW: Also match on calculated values
                        pension_current: currentCalculatedValues.pensionCurrent,
                        pension_restored: currentCalculatedValues.pensionRestored,
                        restoration_date: currentCalculatedValues.restorationDate,
                        tk_allowance: currentCalculatedValues.tkAllowance // <-- ADDED
                    });

                if (deleteError) {
                    console.warn("Error checking/deleting duplicate log:", deleteError);
                    // Don't stop, proceed to insert anyway
                }

                // 2. Insert the new log entry
                const { error: insertError } = await supabaseClient.from('logs').insert(logEntry);
                if (insertError) {
                    throw insertError;
                }
                console.log("Log entry saved (or refreshed):", logEntry);
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }
        
        function openPasswordModal() {
            const passwordModal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            passwordInput.value = '';
            passwordError.style.display = 'none';
            passwordModal.classList.add('visible');
            passwordInput.focus();
        }

        function closePasswordModal() {
            const passwordModal = document.getElementById('password-modal');
            passwordModal.classList.remove('visible');
        }

        // --- NEW: Supabase Clear Log Function ---
        async function confirmClearLog() {
            if (!isSupabaseEnabled) return;

            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            const password = passwordInput.value;

            if (password === 'Smile@786') {
                passwordError.style.display = 'none';
                try {
                    // FIX: Use .delete() with a filter instead of RPC
                    // This satisfies the "DELETE requires a WHERE clause" rule
                    const { error } = await supabaseClient
                        .from('logs')
                        .delete()
                        .neq('id', 0); // Deletes all rows where id is not 0 (i.e., all rows)

                    if (error) {
                        throw error;
                    }
                    closePasswordModal();
                } catch (e) {
                    console.error("Error clearing log: ", e);
                    passwordError.textContent = "Error clearing log. See console.";
                    passwordError.style.display = 'block';
                }
            } else {
                passwordError.textContent = "Incorrect password. Please try again.";
                passwordError.style.display = 'block';
            }
        }

        function loadLogData(button) {
            const data = button.dataset;
            
            const dobInput = document.getElementById('dob');
            const doeInput = document.getElementById('doe');
            const sosInput = document.getElementById('sos');
            const grossPensionInput = document.getElementById('gross-pension-ppo');
            const tkAwardInput = document.getElementById('tk-award');
            const familyPensionInput = document.getElementById('family-pension');
            
            dobInput.value = data.dob || '';
            doeInput.value = data.doe || '';
            sosInput.value = data.sos || '';
            
            const pensionValue = data.pension || '';
            grossPensionInput.value = pensionValue;
            
            const parts = pensionValue.split('.');
            let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            let decimalPart = parts[1] ? (parts[1] + '00').substring(0, 2) : '';
            
            grossPensionInput.value = integerPart;
                if (decimalPart) {
                grossPensionInput.value += '.' + decimalPart;
            }
            if (parseFloat(pensionValue) === 0) {
                grossPensionInput.value = '0';
            }

            tkAwardInput.value = data.tk || 'No';
            familyPensionInput.value = data.family || 'No';

            checkInputEnabling();
            calculateAndDisplayAll();
            
            if (isSupabaseEnabled) {
                clearTimeout(logDebounceTimer);
                if (dobInput.value && doeInput.value && sosInput.value && grossPensionInput.value) {
                    logDebounceTimer = setTimeout(() => {
                        logCalculation('Load Log Data (Debounced)');
                    }, LOG_DEBOUNCE_DELAY);
                }
            }
        }

        let pressTimer;
        let intervalTimer;
        const initialDelay = 500;
        const repeatDelay = 100;

        function startPress(amount) {
            stopPress();
            adjustPension(amount);
            pressTimer = setTimeout(() => {
                intervalTimer = setInterval(() => {
                    adjustPension(amount);
                }, repeatDelay);
            }, initialDelay);
        }

        function stopPress() {
            clearTimeout(pressTimer);
            clearInterval(intervalTimer);
        }

        function adjustPension(amount) {
            const grossPensionInput = document.getElementById('gross-pension-ppo');
            const currentValue = parseFloat(grossPensionInput.value.replace(/,/g, '')) || 0;
            const newValue = Math.max(0, currentValue + amount);
            
            let newValueString = String(roundToTwoDecimals(newValue));
            
            const parts = newValueString.split('.');
            let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            grossPensionInput.value = parts.length > 1 ? integerPart + '.' + parts[1] : integerPart;

            grossPensionInput.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function formatGrossPensionInput(event) {
            let input = event.target.value.replace(/[^0-9.]/g, '');
            const parts = input.split('.');

            if (parts.length > 2) {
                input = parts[0] + '.' + parts.slice(1).join('');
            }
            if (parts.length === 2) {
                parts[1] = parts[1].substring(0, 2);
                input = parts.join('.');
            }
            
            let integerPart = parts[0].replace(/,/g, '');
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            
            event.target.value = parts.length > 1 ? integerPart + '.' + parts[1] : integerPart;
            
            calculateAndDisplayAll();
            
            if (isSupabaseEnabled) {
                clearTimeout(logDebounceTimer);
                const dobInput = document.getElementById('dob');
                const doeInput = document.getElementById('doe');
                const sosInput = document.getElementById('sos');
                if (dobInput.value && doeInput.value && sosInput.value && event.target.value) {
                    logDebounceTimer = setTimeout(() => {
                        logCalculation('Input Change (Debounced)');
                    }, LOG_DEBOUNCE_DELAY);
                }
            }

            checkInputEnabling();
        }

        function populateIncreaseTable(sosDate, grossPension, basePension, dobDate, isFamilyPension) {
            const tbody = document.getElementById('increase-table-body');
            // THIS IS THE FIX: Check if tbody exists before setting innerHTML
            if (!tbody) {
                console.error("Could not find 'increase-table-body'. Skipping table population.");
                return { current: [], restored: [] }; // Return empty results
            }
            tbody.innerHTML = ''; // Clear existing rows
            
            const date1977_04_30 = parseDate('1977-04-30');
            const date1977_05_01 = parseDate('1977-05-01');
            const date1947_08_14 = parseDate('1947-08-14');
            const date1991_06_01 = parseDate('1991-06-01');
            const date1993_06_01 = parseDate('1993-06-01');
            const date1993_06_30 = parseDate('1993-06-30');
            const date2001_12_01 = parseDate('2001-12-01');
            const date1991_05_31 = parseDate('1991-05-31');
            const date1993_07_01 = parseDate('1993-07-01');
            const date1994_06_30 = parseDate('1994-06-30');
            const date1994_07_01 = parseDate('1994-07-01');
            const date1977_04_30_2006 = parseDate('1977-04-30');
            const date1977_05_01_2006 = parseDate('1977-05-01');
            const date1997_06_30_2007 = parseDate('1997-06-30');
            const date2007_07_01_2007 = parseDate('2007-07-01');
            const date1997_07_01_2007 = parseDate('1997-07-01');
            const date2001_06_30_2009 = parseDate('2001-06-30');
            const date2001_07_01_2009 = parseDate('2001-07-01');
            const date2001_11_30_2010 = parseDate('2001-11-30');
            const date2001_07_01_2010 = parseDate('2001-07-01');
            const date2002_06_30_2011 = parseDate('2002-06-30');
            
            let previousNetValueCurrent = basePension; 
            let previousNetValueRestored = grossPension; 
            const currentNetValues = [];
            const restoredNetValues = [];
            let net2024_Current = 0;
            let net2024_Restored = 0;

            pensionIncreases.forEach(item => {
                const row = tbody.insertRow(); 
                const fromDate = parseDate(item.from);
                const toDate = parseDate(item.to);
                
                let isEntitled = 'N';
                let percentageToDisplay = item.percentage;
                const year = item.year;
                
                if (sosDate) {
                    if (year === 1991) {
                        if (sosDate > date1977_04_30) percentageToDisplay = '12%';
                        else if (sosDate < date1977_05_01) percentageToDisplay = '32%';
                        else percentageToDisplay = '0%';
                    } else if (year === 1995) {
                        if (sosDate > date1947_08_14 && sosDate < date1977_04_30) percentageToDisplay = '15%';
                        else if (sosDate > date1977_04_30 && sosDate < date1991_06_01) percentageToDisplay = '10%';
                        else if (sosDate < date1993_06_01) percentageToDisplay = '5%';
                        else percentageToDisplay = '0%';
                    } else if (year === 2001) {
                        if (sosDate > date1993_06_30 && sosDate < date2001_12_01) percentageToDisplay = '5%';
                        else if (sosDate > date1991_05_31 && sosDate < date1993_07_01) percentageToDisplay = '10%';
                        else if (sosDate < date1991_06_01) percentageToDisplay = '15%';
                        else percentageToDisplay = '0%';
                    } else if (year === 2004) {
                        if (sosDate > date1994_06_30) percentageToDisplay = '8%';
                        else if (sosDate < date1994_07_01) percentageToDisplay = '16%'; // Corrected from date1T994_07_01
                        else percentageToDisplay = '0%';
                    } else if (year === 2006) {
                        if (sosDate > date1977_04_30_2006) percentageToDisplay = '15%';
                        else if (sosDate < date1977_05_01_2006) percentageToDisplay = '20%';
                        else percentageToDisplay = '0%';
                    } else if (year === 2007) {
                        if (sosDate > date1997_06_30_2007 && sosDate < date2007_07_01_2007) percentageToDisplay = '15%';
                        else if (sosDate < date1997_07_01_2007) percentageToDisplay = '20%';
                        else percentageToDisplay = '0%';
                    } else if (year === 2009) {
                        if (sosDate > date2001_06_30_2009) percentageToDisplay = '15%';
                        else if (sosDate < date2001_07_01_2009) percentageToDisplay = '20%';
                        else percentageToDisplay = '0%';
                    } else if (year === 2010) {
                        if (sosDate > date2001_11_30_2010) percentageToDisplay = '15%';
                        else if (sosDate < date2001_07_01_2010) percentageToDisplay = '20%';
                        else percentageToDisplay = '0%';
                    } else if (year === 2011) {
                        if (sosDate > date2002_06_30_2011) percentageToDisplay = '15%';
                        else if (sosDate < date2002_06_30_2011) percentageToDisplay = '20%';
                        else percentageToDisplay = '0%';
                    }
                } else if (item.percentage === 'CONDITIONAL') {
                    percentageToDisplay = '-';
                }

                if (sosDate && fromDate && toDate) {
                    const condition1 = (sosDate >= fromDate && sosDate <= toDate);
                    const condition2 = (fromDate >= sosDate); 
                    if (condition1 || condition2) isEntitled = 'Y';
                }

                if (isEntitled === 'N') {
                    row.classList.add('hidden');
                }
                
                let currentBaseLine = previousNetValueCurrent; 
                let currentIncreaseValue = 0;
                let currentNetValue = currentBaseLine; 
                let baseLineDisplayCurrent = '-';
                let restoredBaseLine = previousNetValueRestored;
                let restoredIncreaseValue = 0;
                let restoredNetValue = restoredBaseLine;
                let baseLineDisplayRestored = '-';

                const percentageText = percentageToDisplay.replace('%', '');
                const percentageValue = parseFloat(percentageText) / 100;
                
                let isIncreaseCalculatedCurrent = false;
                let isNetCalculatedCurrent = false; 
                let isIncreaseCalculatedRestored = false;
                let isNetCalculatedRestored = false; 

                const minPensionSelf = minPensionData[year] ? minPensionData[year].self : 0;
                const minPensionFamily = minPensionData[year] ? minPensionData[year].family : 0;
                const applicableMinPension = isFamilyPension ? minPensionFamily : minPensionSelf;
                let minPensionAppliedCurrent = false;
                let minPensionAppliedRestored = false;

                if (year === 1987) { 
                    restoredBaseLine = grossPension;
                    if (isEntitled === 'Y' && !isNaN(percentageValue) && grossPension > 0) {
                        restoredIncreaseValue = roundToTwoDecimals(percentageValue * grossPension);
                        isIncreaseCalculatedRestored = true;
                    } else {
                        restoredIncreaseValue = 0;
                    }
                    restoredNetValue = roundToTwoDecimals(restoredBaseLine + restoredIncreaseValue);
                    isNetCalculatedRestored = true;

                    currentIncreaseValue = restoredIncreaseValue;
                    isIncreaseCalculatedCurrent = isIncreaseCalculatedRestored;
                    if (currentIncreaseValue > 0) {
                        currentNetValue = roundToTwoDecimals(currentIncreaseValue + grossPension - basePension);
                    } else {
                        currentNetValue = roundToTwoDecimals(basePension);
                    }
                    isNetCalculatedCurrent = true;
                } else if (year === 1988) {
                    restoredBaseLine = previousNetValueRestored; 
                    if (isEntitled === 'Y' && !isNaN(percentageValue)) {
                        const baseForIncrease = Math.max(restoredBaseLine, applicableMinPension);
                        restoredIncreaseValue = roundToTwoDecimals(baseForIncrease * percentageValue); 
                        isIncreaseCalculatedRestored = true;
                    } else {
                        restoredIncreaseValue = 0;
                    }
                    restoredNetValue = roundToTwoDecimals(restoredBaseLine + restoredIncreaseValue);
                    isNetCalculatedRestored = true;

                    currentIncreaseValue = restoredIncreaseValue;
                    isIncreaseCalculatedCurrent = isIncreaseCalculatedRestored;
                    currentNetValue = roundToTwoDecimals(previousNetValueCurrent + currentIncreaseValue);
                    isNetCalculatedCurrent = true;
                } else if (year === 1990) {
                    restoredBaseLine = previousNetValueRestored;
                    if (isEntitled === 'Y' && !isNaN(percentageValue)) {
                        const baseForIncrease = Math.max(restoredBaseLine, applicableMinPension);
                        restoredIncreaseValue = roundToTwoDecimals(baseForIncrease * percentageValue); 
                        isIncreaseCalculatedRestored = true;
                    } else {
                        restoredIncreaseValue = 0;
                    }
                    restoredNetValue = roundToTwoDecimals(restoredBaseLine + restoredIncreaseValue);
                    isNetCalculatedRestored = true;
                    
                    currentIncreaseValue = restoredIncreaseValue;
                    isIncreaseCalculatedCurrent = isIncreaseCalculatedRestored;
                    if (currentIncreaseValue > 0) {
                        currentNetValue = roundToTwoDecimals(currentIncreaseValue + grossPension - basePension);
                    } else {
                        currentNetValue = roundToTwoDecimals(basePension);
                    }
                    isNetCalculatedCurrent = true;
                } else if (year >= 1991 && year <= 1999) {
                    restoredBaseLine = previousNetValueRestored;
                    if (isEntitled === 'Y' && !isNaN(percentageValue)) {
                        const baseForIncrease = Math.max(restoredBaseLine, applicableMinPension);
                        restoredIncreaseValue = roundToTwoDecimals(baseForIncrease * percentageValue); 
                        isIncreaseCalculatedRestored = true;
                    } else {
                        restoredIncreaseValue = 0;
                    }
                    restoredNetValue = roundToTwoDecimals(restoredBaseLine + restoredIncreaseValue);
                    isNetCalculatedRestored = true;

                    currentIncreaseValue = restoredIncreaseValue;
                    isIncreaseCalculatedCurrent = isIncreaseCalculatedRestored;
                    currentNetValue = roundToTwoDecimals(previousNetValueCurrent + currentIncreaseValue);
                    isNetCalculatedCurrent = true;
                } else if (year >= 2001 && year <= 2024) {
                    if (isEntitled === 'Y' && !isNaN(percentageValue)) {
                        currentIncreaseValue = roundToTwoDecimals(percentageValue * previousNetValueCurrent);
                        isIncreaseCalculatedCurrent = true;
                    } else {
                        currentIncreaseValue = 0;
                    }
                    currentNetValue = roundToTwoDecimals(previousNetValueCurrent + currentIncreaseValue);
                    isNetCalculatedCurrent = true;

                    if (isEntitled === 'Y' && !isNaN(percentageValue)) {
                        restoredIncreaseValue = roundToTwoDecimals(restoredBaseLine * percentageValue);
                        isIncreaseCalculatedRestored = true;
                    } else {
                        restoredIncreaseValue = 0;
                    }
                    restoredNetValue = roundToTwoDecimals(restoredBaseLine + restoredIncreaseValue);
                    isNetCalculatedRestored = true;
                } else if (year === 2025) {
                    currentBaseLine = net2024_Current; 
                    baseLineDisplayCurrent = formatCurrency(currentBaseLine, false, true);
                    if (isEntitled === 'Y' && percentageValue > 0) {
                            currentIncreaseValue = roundToTwoDecimals(percentageValue * currentBaseLine); 
                        isIncreaseCalculatedCurrent = true;
                    } else {
                        currentIncreaseValue = 0;
                    }
                    currentNetValue = roundToTwoDecimals(currentIncreaseValue + net2024_Current);
                    isNetCalculatedCurrent = true;
                    
                    restoredBaseLine = net2024_Restored; 
                    baseLineDisplayRestored = formatCurrency(restoredBaseLine, false, true);
                    if (isEntitled === 'Y' && !isNaN(percentageValue)) {
                        restoredIncreaseValue = roundToTwoDecimals(restoredBaseLine * percentageValue);
                        isIncreaseCalculatedRestored = true;
                    } else {
                        restoredIncreaseValue = 0;
                    }
                    restoredNetValue = roundToTwoDecimals(restoredBaseLine + restoredIncreaseValue);
                    isNetCalculatedRestored = true;
                }

                if (year > 1999) {
                    if (isEntitled === 'Y' && isNetCalculatedCurrent && applicableMinPension > 0 && currentNetValue < applicableMinPension) {
                        currentNetValue = applicableMinPension;
                        minPensionAppliedCurrent = true;
                    }
                    if (isEntitled === 'Y' && isNetCalculatedRestored && applicableMinPension > 0 && restoredNetValue < applicableMinPension) {
                        restoredNetValue = applicableMinPension;
                        minPensionAppliedRestored = true;
                    }
                }
                
                if (isNetCalculatedCurrent) previousNetValueCurrent = currentNetValue;
                if (isNetCalculatedRestored) previousNetValueRestored = restoredNetValue;
                if (year === 2024) {
                    net2024_Current = currentNetValue;
                    net2024_Restored = restoredNetValue;
                }
                if (isNetCalculatedCurrent) currentNetValues.push(currentNetValue);
                if (isNetCalculatedRestored) restoredNetValues.push(restoredNetValue);

                row.insertCell().textContent = year;
                row.insertCell().textContent = percentageToDisplay;
                row.insertCell().textContent = year === 2025 ? baseLineDisplayCurrent : '-'; 
                row.insertCell().textContent = isIncreaseCalculatedCurrent ? formatCurrency(currentIncreaseValue, false, true) : '-';
                const netCellCurrent = row.insertCell();
                netCellCurrent.textContent = isNetCalculatedCurrent ? formatCurrency(currentNetValue, false, true) : '-';
                if (minPensionAppliedCurrent) netCellCurrent.classList.add('text-blue-600', 'font-bold');
                row.insertCell().textContent = year === 2025 ? baseLineDisplayRestored : '-';
                row.insertCell().textContent = isIncreaseCalculatedRestored ? formatCurrency(restoredIncreaseValue, false, true) : '-';
                const netCellRestored = row.insertCell();
                netCellRestored.textContent = isNetCalculatedRestored ? formatCurrency(restoredNetValue, false, true) : '-';
                if (minPensionAppliedRestored) netCellRestored.classList.add('text-blue-600', 'font-bold');
                
                row.insertCell().textContent = isEntitled;
                row.cells[8].classList.add('hidden-column');
                row.insertCell().textContent = formatDateTable(item.from);
                row.cells[9].classList.add('hidden-column');
                row.insertCell().textContent = formatDateTable(item.to);
                row.cells[10].classList.add('hidden-column');
                row.insertCell().textContent = minPensionSelf > 0 ? formatCurrency(minPensionSelf, false, true) : '-';
                row.cells[11].classList.add('hidden-column');
                row.insertCell().textContent = minPensionFamily > 0 ? formatCurrency(minPensionFamily, false, true) : '-';
                row.cells[12].classList.add('hidden-column');
            });
            
            return { current: currentNetValues, restored: restoredNetValues };
        }


        function calculateAndDisplayAll() {
            try {
                const dobInput = document.getElementById('dob');
                const doeInput = document.getElementById('doe');
                const sosInput = document.getElementById('sos');
                const grossPensionInput = document.getElementById('gross-pension-ppo');
                const tkAwardInput = document.getElementById('tk-award');
                const familyPensionInput = document.getElementById('family-pension');

                const dobDate = parseDate(dobInput.value);
                const doeDate = parseDate(doeInput.value);
                const sosDate = parseDate(sosInput.value);
                const tkAward = tkAwardInput.value;
                const isFamilyPension = familyPensionInput.value === 'Yes';
                const grossPensionPPO = parseFloat(grossPensionInput.value.replace(/,/g, '')) || 0;
                
                document.getElementById('dob-display').textContent = formatDateDisplay(dobDate);
                document.getElementById('doe-display').textContent = formatDateDisplay(doeDate);
                document.getElementById('sos-display').textContent = formatDateDisplay(sosDate);

                let roundedQS = 0;
                let ageNextBirthday = 0;
                let commutationFactor = 0;
                let restorationDate = null;
                
                if (doeDate && sosDate) {
                    const serviceInMillis = sosDate - doeDate;
                    const serviceInYearsDecimal = serviceInMillis / (1000 * 60 * 60 * 24 * 365.25);
                    roundedQS = Math.round(serviceInYearsDecimal);

                    if (dobDate) {
                        const sosPlusOneDay = new Date(sosDate);
                        sosPlusOneDay.setUTCDate(sosPlusOneDay.getUTCDate() + 1);
                        const ageAtSOSInYears = (sosPlusOneDay - dobDate) / (1000 * 60 * 60 * 24 * 365.25);
                        ageNextBirthday = Math.ceil(ageAtSOSInYears);
                    }

                    let factorsToUse = null;
                    const policyDate2001 = parseDate('2001-12-01');
                    const policyDate1986 = parseDate('1986-07-01');
                    if (sosDate >= policyDate2001) factorsToUse = factors_2001_12_01;
                    else if (sosDate >= policyDate1986) factorsToUse = factors_1986_07_01;
                    else factorsToUse = factors_1966_07_01;
                    commutationFactor = factorsToUse[ageNextBirthday] || 0;

                    const roundedCommutationFactor = Math.round(commutationFactor);
                    restorationDate = new Date(sosDate);
                    // --- MODIFIED: Add one day to restoration date ---
                    restorationDate.setUTCDate(restorationDate.getUTCDate() + 1);
                    restorationDate.setUTCFullYear(restorationDate.getUTCFullYear() + roundedCommutationFactor);
                }
                
                let grossPension = grossPensionPPO;
                if (isFamilyPension) {
                    grossPension = roundToTwoDecimals(grossPensionPPO * 0.75);
                }

                let commutedPensionPercentage = 0;
                if (sosDate) {
                    const date2005 = parseDate('2005-06-30');
                    const date2001 = parseDate('2001-11-30');
                    if (sosDate > date2005) commutedPensionPercentage = 0.35;
                    else if (sosDate > date2001) commutedPensionPercentage = 0.40;
                    else commutedPensionPercentage = 0.50;
                }
                const commutedPension = roundToTwoDecimals(grossPension * commutedPensionPercentage);
                const basePension = roundToTwoDecimals(grossPension - commutedPension);
                const commutationAmount = roundToTwoDecimals(grossPensionPPO * commutedPensionPercentage * commutationFactor * 12);

                const netValues = populateIncreaseTable(sosDate, grossPension, basePension, dobDate, isFamilyPension);
                
                let finalPensionCurrent = basePension;
                if (netValues.current.length > 0) {
                    finalPensionCurrent = Math.max(basePension, ...netValues.current);
                }
                finalPensionCurrent = Math.ceil(finalPensionCurrent);

                let finalPensionRestored = grossPension; 
                if (netValues.restored.length > 0) {
                    finalPensionRestored = Math.max(grossPension, ...netValues.restored);
                }
                finalPensionRestored = Math.ceil(finalPensionRestored);

                let tkAllowance = 0;
                if (tkAward === '1') tkAllowance = 170;
                else if (tkAward === '2') tkAllowance = 130;
                else if (tkAward === '3') tkAllowance = 70;
                
                // NEW: Calculate Total Payables
                let totalPayableCurrent = finalPensionCurrent + tkAllowance;
                let totalPayableRestored = finalPensionRestored + tkAllowance;

                document.getElementById('qs-output').textContent = `${roundedQS} Years`;
                document.getElementById('age-at-sos-output').textContent = `${ageNextBirthday} Years`;
                document.getElementById('commutation-factor-output').textContent = commutationFactor.toFixed(4);
                document.getElementById('gross-pension-output').textContent = formatCurrency(grossPension);
                document.getElementById('net-pension-pre-increase-output').textContent = formatCurrency(basePension);
                document.getElementById('commuted-pension-output').textContent = formatCurrency(commutedPension);
                document.getElementById('commutation-amount-output').textContent = formatCurrency(commutationAmount);
                document.getElementById('pension-pm-current-output').textContent = formatCurrency(finalPensionCurrent, true);
                document.getElementById('pension-pm-restored-output').textContent = formatCurrency(finalPensionRestored, true);
                document.getElementById('tk-allowance-current-output').textContent = formatCurrency(tkAllowance);
                
                // NEW: Display Total Payables
                document.getElementById('total-payable-current-output').textContent = formatCurrency(totalPayableCurrent, true);
                document.getElementById('total-payable-restored-output').textContent = formatCurrency(totalPayableRestored, true);
                
                const restorationOutputSpan = document.getElementById('restoration-date-output');
                const restorationDateFormatted = restorationDate ? formatDateDisplay(restorationDate) : 'N/A';
                restorationOutputSpan.textContent = restorationDateFormatted;
                
                if (restorationDate) {
                    const today = parseDate(getTodayDateString());
                    restorationOutputSpan.className = 'value'; 
                    if (restorationDate > today) {
                        restorationOutputSpan.classList.add('text-red-600', 'font-bold');
                    } else {
                        restorationOutputSpan.classList.add('text-green-600', 'font-bold', 'flashing');
                    }
                } else {
                        restorationOutputSpan.className = 'value text-gray-800'; 
                }
                
                let restorationAgeDisplay = 'N/A';
                if (dobDate && restorationDate && restorationDate > dobDate) {
                    let totalMonths = (restorationDate.getUTCFullYear() - dobDate.getUTCFullYear()) * 12;
                    totalMonths -= dobDate.getUTCMonth();
                    totalMonths += restorationDate.getUTCMonth();
                    if (restorationDate.getUTCDate() < dobDate.getUTCDate()) {
                        totalMonths--;
                    }
                    const restorationAgeYears = Math.floor(totalMonths / 12);
                    const restorationAgeMonths = totalMonths % 12;
                    let yearsString = `${restorationAgeYears} Years`;
                    let monthsString = (restorationAgeMonths === 1) ? `, 1 Month` : (restorationAgeMonths > 1) ? `, ${restorationAgeMonths} Months` : '';
                    restorationAgeDisplay = yearsString + monthsString;
                }
                document.getElementById('age-at-restoration-output').textContent = restorationAgeDisplay;

                // NEW: Store raw calculated values for logging
                currentCalculatedValues.pensionCurrent = finalPensionCurrent;
                currentCalculatedValues.pensionRestored = finalPensionRestored;
                currentCalculatedValues.restorationDate = restorationDateFormatted;
                currentCalculatedValues.tkAllowance = tkAllowance; // <-- ADDED
                
            } catch (error) {
                console.error("Error in calculateAndDisplayAll:", error);
                throw error; // Re-throw the error to be caught by the top-level handler
            }
        }
        
        function checkInputEnabling() {
            const dobInput = document.getElementById('dob');
            const doeInput = document.getElementById('doe');
            const sosInput = document.getElementById('sos');
            const grossPensionInput = document.getElementById('gross-pension-ppo');
            const tkAwardInput = document.getElementById('tk-award');
            const familyPensionInput = document.getElementById('family-pension');
            const increasePensionBtn = document.getElementById('increase-pension');
            const decreasePensionBtn = document.getElementById('decrease-pension');

            const dobFilled = dobInput.value !== '';
            const doeFilled = doeInput.value !== '';
            const sosFilled = sosInput.value !== '';
            const grossPensionFilled = grossPensionInput.value !== '' && parseFloat(grossPensionInput.value.replace(/,/g, '')) > 0;

            doeInput.disabled = !dobFilled;
            sosInput.disabled = !(dobFilled && doeFilled);
            grossPensionInput.disabled = !(dobFilled && doeFilled && sosFilled);
            increasePensionBtn.disabled = !(dobFilled && doeFilled && sosFilled);
            decreasePensionBtn.disabled = !(dobFilled && doeFilled && sosFilled);
            tkAwardInput.disabled = !(dobFilled && doeFilled && sosFilled && grossPensionFilled);
            familyPensionInput.disabled = !(dobFilled && doeFilled && sosFilled && grossPensionFilled);

            if (doeInput.disabled) {
                doeInput.value = '';
                document.getElementById('doe-display').textContent = '';
            }
            if (sosInput.disabled) {
                sosInput.value = '';
                document.getElementById('sos-display').textContent = '';
            }
            if (grossPensionInput.disabled) grossPensionInput.value = '';
            if (tkAwardInput.disabled) tkAwardInput.value = 'No';
            if (familyPensionInput.disabled) familyPensionInput.value = 'No';
        }
        
        // --- NEW: Supabase Visit Counter ---
        async function initVisitCounter() {
            if (!isSupabaseEnabled) return; 
            
            const visitCountSpan = document.getElementById('visit-count');
            if (!visitCountSpan) return;

            try {
                // 1. Increment the count by calling the 'increment_visits' RPC function
                const { data: rpcData, error: rpcError } = await supabaseClient.rpc('increment_visits');
                if (rpcError) throw rpcError;
                
                // 2. Set the count from the RPC's return value
                if (rpcData) {
                    visitCountSpan.textContent = formatVisitCount(rpcData); // Use formatter
                }

                // 3. Listen for REALTIME updates from other users
                supabaseClient.channel('visits-channel')
                    .on(
                        'postgres_changes',
                        { event: 'UPDATE', schema: 'public', table: 'visits', filter: 'id=eq.1' },
                        (payload) => {
                            // When an update happens, set the new count
                            visitCountSpan.textContent = formatVisitCount(payload.new.count); // Use formatter
                        }
                    )
                    .subscribe();

            } catch (e) {
                console.error("Failed to update visit count:", e);
                // If increment fails, just try to fetch the current count
                try {
                    const { data, error } = await supabaseClient.from('visits').select('count').eq('id', 1).single();
                    if (error) throw error;
                    visitCountSpan.textContent = formatVisitCount(data.count); // Use formatter
                } catch (fetchError) {
                     console.error("Failed to fetch visit count:", fetchError);
                     visitCountSpan.textContent = 'Error';
                }
            }
        }

        // --- NEW: Supabase Log Listener ---
        
        // This helper function fetches all logs and renders them
        async function fetchLogs() {
            if (!isSupabaseEnabled) return; 

            try {
                const { data, error } = await supabaseClient
                    .from('logs')
                    .select('*')
                    .order('created_at', { ascending: false }) // Get newest first
                    .limit(50); // Get latest 50 logs
                
                if (error) throw error;
                
                renderLog(data || []);
            } catch (error) {
                console.error("Error fetching logs: ", error);
                const logContainer = document.getElementById('log-container');
                if(logContainer) logContainer.innerHTML = '<span class="text-red-500">Error loading log.</span>';
            }
        }

        function initLogListener() {
            if (!isSupabaseEnabled) return; 

            // 1. Fetch initial logs on load
            fetchLogs();

            // 2. Listen for REALTIME inserts
            supabaseClient.channel('logs-channel')
                .on(
                    'postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'logs' },
                    (payload) => {
                        // A new log was added, re-fetch the list
                        fetchLogs();
                    }
                )
                .on(
                    'postgres_changes',
                    { event: 'DELETE', schema: 'public', table: 'logs' },
                    (payload) => {
                        // Logs were deleted (cleared), re-fetch the (now empty) list
                        fetchLogs();
                    }
                )
                .subscribe();
        }

        // --- App Entry Point (DOM Ready) ---
        document.addEventListener('DOMContentLoaded', async () => {
            const appWarning = document.getElementById('app-warning');
            
            function showWarning(message) {
                if (appWarning) {
                    appWarning.textContent = message;
                    appWarning.style.display = 'block';
                }
                console.warn(message);
            }

            // --- 1. Try to initialize Supabase ---
            if (!SUPABASE_URL || SUPABASE_URL.includes("PASTE_YOUR")) {
                showWarning("Supabase is not configured. Online features are disabled. Please paste your URL and Key into index.html.");
                isSupabaseEnabled = false;
                // Hide online features
                document.getElementById('visit-counter-wrapper').style.display = 'none';
                document.getElementById('log-wrapper').style.display = 'none';
            } else {
                // Config is present, try to connect
                try {
                    // Initialize the client
                    supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    if (!supabaseClient) {
                        throw new Error("Supabase client failed to initialize.");
                    }
                    
                    isSupabaseEnabled = true; 
                    console.log("Supabase initialized successfully.");
                    
                } catch (e) {
                    console.error("Error initializing Supabase:", e);
                    showWarning(`Error initializing online features: ${e.message}. App is in offline mode.`);
                    isSupabaseEnabled = false;
                    // Hide online features
                    document.getElementById('visit-counter-wrapper').style.display = 'none';
                    document.getElementById('log-wrapper').style.display = 'none';
                }
            }

            // --- 2. Initialize the App (Core + Online Listeners) ---
            const allInputs = document.querySelectorAll('.calc-input');
            const grossPensionInput = document.getElementById('gross-pension-ppo');
            const increasePensionBtn = document.getElementById('increase-pension');
            const decreasePensionBtn = document.getElementById('decrease-pension');
            const clearLogBtn = document.getElementById('clear-log-btn');
            const cancelClearBtn = document.getElementById('cancel-clear-btn');
            const confirmClearBtn = document.getElementById('confirm-clear-btn');
            const passwordInput = document.getElementById('password-input');
            const logContainer = document.getElementById('log-container');

            // THIS IS THE FIX: Check for elements *inside* the DOMContentLoaded listener
            // to ensure they exist before adding event listeners.
            if (!allInputs.length || !grossPensionInput || !increasePensionBtn || !decreasePensionBtn || !clearLogBtn || !cancelClearBtn || !confirmClearBtn || !passwordInput || !logContainer) {
                console.error("CRITICAL ERROR: One or more required HTML elements are missing from the page.");
                showWarning("CRITICAL ERROR: Page HTML is incomplete. Please reload.");
                return; // Stop execution to prevent further errors
            }


            allInputs.forEach(input => {
                if(input.id !== 'gross-pension-ppo') {
                    input.addEventListener('input', () => { 
                        try {
                            calculateAndDisplayAll();
                        } catch (e) {
                            console.error("Error during calculation on input:", e);
                        }
                        
                        if (isSupabaseEnabled) {
                            clearTimeout(logDebounceTimer);
                            const dobInput = document.getElementById('dob');
                            const doeInput = document.getElementById('doe');
                            const sosInput = document.getElementById('sos');
                            const grossPensionInput = document.getElementById('gross-pension-ppo');

                            // FIX: Only set timer if all 4 required fields are filled
                            if (dobInput.value && doeInput.value && sosInput.value && grossPensionInput.value && parseFloat(grossPensionInput.value.replace(/,/g, '')) > 0) {
                                logDebounceTimer = setTimeout(() => {
                                    logCalculation('Input Change (Debounced)');
                                }, LOG_DEBOUNCE_DELAY);
                            }
                        }
                        checkInputEnabling();
                    });
                }
            });

            grossPensionInput.addEventListener('input', formatGrossPensionInput); // This function also handles its own debouncing
            
            increasePensionBtn.addEventListener('mousedown', () => startPress(1));
            decreasePensionBtn.addEventListener('mousedown', () => startPress(-1));
            document.addEventListener('mouseup', stopPress);
            document.addEventListener('mouseleave', stopPress);
            increasePensionBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress(1); });
            decreasePensionBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress(-1); });
            document.addEventListener('touchend', stopPress);
            document.addEventListener('touchcancel', stopPress);
            
            // Only attach these listeners if Supabase is on
            if (isSupabaseEnabled) {
                clearLogBtn.addEventListener('click', openPasswordModal);
                cancelClearBtn.addEventListener('click', closePasswordModal);
                confirmClearBtn.addEventListener('click', confirmClearLog);
                
                logContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('load-log-btn')) {
                        loadLogData(e.target);
                    }
                });

                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        confirmClearLog();
                    }
                });
            } else {
                 // If Supabase is off, hide the buttons
                clearLogBtn.style.display = 'none';
            }
            
            initVisitCounter(); // Has internal check
            initLogListener();  // Has internal check
            
            try {
                calculateAndDisplayAll();
            } catch (e) {
                console.error("Error during initial calculation:", e);
            }
            checkInputEnabling();
        });

    </script>
</body>
</html>